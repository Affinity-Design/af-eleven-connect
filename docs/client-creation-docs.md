# Client Account Creation

## Overview

This document details the process of creating a new client account in the Eleven Labs Outbound Caller system. Client accounts represent businesses or individuals who will use the system to make outbound calls using the ElevenLabs Conversational AI technology.

Client accounts contain essential information such as contact details, assigned agent configurations, Twilio phone number assignments, and GoHighLevel (GHL) calendar IDs for integration. Each client receives unique authentication credentials to access the secure client API endpoints. Additionally, clients can be linked to GHL sub-accounts for integration with GHL features like calendar management.

## Prerequisites

Before creating a client account, ensure you have:

1. Administrator access to the system (with a valid admin JWT token)
2. A valid ElevenLabs agent ID to assign to the client
3. A provisioned Twilio phone number to assign to the client
4. Accurate contact information for the client
5. For GHL integration:
   - A GHL application registered in the Developer Marketplace with a `Client ID` and `Client Secret`
   - The GHL sub-account ID (Location ID) for the client, if integrating with GHL
   - The GHL calendar ID (`calId`) for the sub-account, if using calendar features

## Client Creation Process

### API Endpoint Details

Creating a client account requires an authenticated request to the admin API endpoint.

**Endpoint:** `POST /admin/clients`  
**Authentication:** Admin token required  
**Content-Type:** application/json

### Request Format

Below is the API request to create a new client account:

```bash
curl -X POST https://api.v1.affinitydesign.ca/admin/clients \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "5C3JSOVVFiVmBoh8mv3I",
    "calId": "e0JBV5PARC9sbebxcYnY",
    "clientMeta": {
      "fullName": "Paul Giovanatto",
      "email": "paul@affinitydesign.ca",
      "phone": "+19058363456",
      "businessName": "Affinity Design",
      "city": "Canada",
      "jobTitle": "CEO",
      "notes": "The Boss ;)"
    },
    "agentId": "qvu7240QhEUKLultBI7i",
    "twilioPhoneNumber": "+18632704910",
    "status": "Active"
  }'
```

### Request Field Descriptions

#### Required Fields

- **clientId**: Unique identifier for the client (if integrating with GHL, this should be the GHL sub-account ID, e.g., `5C3JSOVVFiVmBoh8mv3I`)
- **clientMeta.fullName**: The client's full name (e.g., "Paul Giovanatto")
- **clientMeta.email**: The client's email address (must be unique, e.g., "paul@affinitydesign.ca")
- **clientMeta.phone**: The client's phone number (in E.164 format, e.g., "+19058363456")
- **agentId**: The ID of the ElevenLabs conversational agent assigned to this client (e.g., "qvu7240QhEUKLultBI7i")
- **twilioPhoneNumber**: The Twilio phone number assigned to this client (in E.164 format, e.g., "+18632704910")

#### Optional Fields

- **calId**: The GHL calendar ID for the sub-account, used for calendar-related API calls (e.g., "e0JBV5PARC9sbebxcYnY")
- **clientMeta.businessName**: The client's company or organization name (e.g., "Affinity Design")
- **clientMeta.city**: The client's city or region (e.g., "Canada")
- **clientMeta.jobTitle**: The client's professional title (e.g., "CEO")
- **clientMeta.notes**: Additional information about the client (e.g., "The Boss ;)")
- **status**: Client account status (defaults to "Active" if not specified; other values: "Inactive", "Suspended")

#### Generated Fields

- **clientSecret**: A secure key for client authentication (not related to GHL; this is for your app's authentication). This is automatically generated by the system when the `POST /admin/clients` endpoint is called for the first time to create the client.

### Response Format

Upon successful creation, the system returns a response with the new client's details, including the generated `clientSecret`:

```json
{
  "message": "Client created successfully",
  "client": {
    "clientId": "5C3JSOVVFiVmBoh8mv3I",
    "calId": "e0JBV5PARC9sbebxcYnY",
    "status": "Active",
    "agentId": "qvu7240QhEUKLultBI7i",
    "twilioPhoneNumber": "+18632704910",
    "clientMeta": {
      "fullName": "Paul Giovanatto",
      "email": "paul@affinitydesign.ca",
      "phone": "+19058363456",
      "businessName": "Affinity Design",
      "city": "Canada",
      "jobTitle": "CEO",
      "notes": "The Boss ;)"
    },
    "clientSecret": "generated_secure_secret_key",
    "createdAt": "2025-03-20T12:00:00.000Z",
    "updatedAt": "2025-03-20T12:00:00.000Z"
  }
}
```

> **Important Security Note**: The response includes the `clientSecret`, which is generated automatically during client creation. For security purposes, the `clientSecret` will not be retrievable in subsequent API calls unless explicitly reset.

## Linking a Client to a GoHighLevel Sub-Account

To enable GHL integration (e.g., for calendar or contact management), you must link the client to a GHL sub-account by initiating the OAuth 2.0 authorization flow. This step is required to obtain GHL access and refresh tokens for the sub-account, which are stored in the client's record.

### Step 1: Generate the GHL Authorization URL

Use the authorization URL generator endpoint to create a properly formatted URL for the GoHighLevel OAuth flow:

```bash
curl -X GET https://api.v1.affinitydesign.ca/integrations/authorize/5C3JSOVVFiVmBoh8mv3I \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

This will return a response with the authorization URL and current integration status:

```json
{
  "authorizationUrl": "https://marketplace.leadconnectorhq.com/oauth/chooselocation?response_type=code&client_id=YOUR_GHL_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&scope=contacts.readonly%20contacts.write%20calendars/resources.write%20calendars/resources.readonly%20calendars/groups.write%20calendars/groups.readonly%20calendars/events.write%20calendars/events.readonly%20calendars.write%20calendars.readonly%20companies.readonly&state=5C3JSOVVFiVmBoh8mv3I",
  "clientId": "5C3JSOVVFiVmBoh8mv3I",
  "currentIntegrationStatus": {
    "hasAccessToken": false,
    "hasRefreshToken": false,
    "tokenExpiresAt": null
  }
}
```

### Step 2: Initiate GHL Authorization

Direct the sub-account owner (or an admin acting on their behalf) to the authorization URL returned in the previous step. This URL should be opened in a browser where the user is logged into their GoHighLevel account.

The user will:
1. Log in to GoHighLevel (if not already logged in)
2. Select the location (sub-account) to connect
3. Approve the requested permissions

#### Notes

- **Browser Interaction Required**: This step requires browser interaction and cannot be completed programmatically via API calls.
- **State Parameter**: The `state` parameter is used to track which client in your system is being authenticated.
- **Redirect**: After approval, GHL redirects to your callback URL with an authorization code and the state parameter (e.g., `https://api.v1.affinitydesign.ca/integrations/callback?code=<AUTH_CODE>&state=5C3JSOVVFiVmBoh8mv3I`).

### Step 3: Token Exchange (Handled Automatically)

Your app's `/integrations/callback` endpoint will automatically handle the redirect, exchange the `code` for tokens, and store them in the client's record. The system:

1. Receives the authorization code from GoHighLevel
2. Exchanges the code for access and refresh tokens via the GoHighLevel API
3. Updates the client record with these tokens

The stored tokens include:

- `accessToken`: GHL access token (stored in a dedicated field)
- `refreshToken`: GHL refresh token
- `tokenExpiresAt`: Token expiration time

No manual action is required for this step as it's handled automatically by your system's callback handler.

### Step 4: Verify Integration

After the authorization process completes, verify that the client record has been updated with the GoHighLevel tokens:

```bash
curl -X GET https://api.v1.affinitydesign.ca/admin/clients/5C3JSOVVFiVmBoh8mv3I/ghl-token-status \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

The response should show the client's GHL token status:

```json
{
  "clientId": "5C3JSOVVFiVmBoh8mv3I",
  "hasAccessToken": true,
  "hasRefreshToken": true,
  "tokenExpiresAt": "2025-03-21T15:30:45.398Z",
  "status": "valid",
  "message": "Token is valid for 4 hours and 28 minutes"
}
```

## GoHighLevel Token Management

The system now includes comprehensive token management for GHL integration. The following mechanisms ensure your integration stays operational:

### Automatic Token Refresh

Access tokens are automatically refreshed when they expire. The system:
1. Checks token validity before making any GHL API calls
2. Refreshes expired or soon-to-expire tokens using the refresh token
3. Updates the client record with the new tokens

### Token Status Checking

Administrators can check the status of a client's GHL integration:

```bash
curl -X GET https://api.v1.affinitydesign.ca/admin/clients/5C3JSOVVFiVmBoh8mv3I/ghl-token-status \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

This provides detailed information about token status:
- Whether access and refresh tokens are present
- Token expiration time
- Human-readable status (valid, expired, expiring soon, etc.)

### Manual Token Refresh

If needed, administrators can manually refresh a client's GHL access token:

```bash
curl -X POST https://api.v1.affinitydesign.ca/admin/clients/5C3JSOVVFiVmBoh8mv3I/refresh-ghl-token \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{}'
```

The system will only refresh if needed. To force a refresh regardless of current status:

```bash
curl -X POST https://api.v1.affinitydesign.ca/admin/clients/5C3JSOVVFiVmBoh8mv3I/refresh-ghl-token \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{"force": true}'
```

### Token Migration

For system administrators, there's a one-time migration endpoint to ensure all clients with GHL integration have the proper token structure:

```bash
curl -X POST https://api.v1.affinitydesign.ca/admin/migrate-ghl-tokens \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{}'
```

This is particularly useful when updating from an older version of the system.

## Setting Up a Client Access Token

After creating a client account and linking it to a GHL sub-account (if applicable), the client needs a JWT access token to authenticate and use the secure `/secure/*` endpoints in your app. This token is obtained by logging in with the `clientId` and `clientSecret`.

### API Endpoint Details

**Endpoint:** `POST /auth/login`  
**Authentication:** None (uses `clientId` and `clientSecret`)  
**Content-Type:** application/json

### Request Format

The client (or an admin on their behalf) can request a token using the following API call:

```bash
curl -X POST https://api.v1.affinitydesign.ca/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "5C3JSOVVFiVmBoh8mv3I",
    "clientSecret": "generated_secure_secret_key"
  }'
```

### Request Field Descriptions

- **clientId**: The unique identifier assigned to the client during creation (e.g., "5C3JSOVVFiVmBoh8mv3I")
- **clientSecret**: The secret key generated for the client during creation (e.g., "generated_secure_secret_key")

### Response Format

Upon successful login, the system returns a JWT token and client details:

```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6IjVDM0pTT1ZWRmlWbUJvaDhtdjNJIiwidHlwZSI6ImNsaWVudCIsImlhdCI6MTcxMTAyMjQwMH0...",
  "client": {
    "clientId": "5C3JSOVVFiVmBoh8mv3I",
    "calId": "e0JBV5PARC9sbebxcYnY",
    "status": "Active",
    "twilioPhoneNumber": "+18632704910",
    "agentId": "qvu7240QhEUKLultBI7i",
    "clientMeta": {
      "fullName": "Paul Giovanatto",
      "businessName": "Affinity Design",
      "email": "paul@affinitydesign.ca"
    }
  }
}
```

#### Response Fields

- **success**: Indicates the login attempt was successful
- **token**: The JWT access token to be used in the `Authorization` header for secure endpoints
- **client**: Basic client information returned for confirmation

### Using the Access Token

The client must include the token in the `Authorization` header for all `/secure/*` endpoint requests. Example:

```bash
curl -X GET https://api.v1.affinitydesign.ca/secure/client \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6IjVDM0pTT1ZWRmlWbUJvaDhtdjNJIiwidHlwZSI6ImNsaWVudCIsImlhdCI6MTcxMTAyMjQwMH0..."
```

#### Error Responses

- **Invalid Credentials**:

  ```json
  {
    "error": "Invalid credentials or inactive client"
  }
  ```

  **Status Code**: 401 Unauthorized

- **Missing Fields**:
  ```json
  {
    "error": "Missing required fields",
    "requiredFields": ["clientId", "clientSecret"]
  }
  ```
  **Status Code**: 400 Bad Request

> **Security Note**: The access token does not expire by default. Clients should store it securely and treat it as sensitive, as it grants full access to their account until revoked or the `clientSecret` is changed.

## Retrieving the Client Secret

If you need to view or regenerate the client secret (e.g., if lost), use the reset secret endpoint:

```bash
curl -X POST https://api.v1.affinitydesign.ca/admin/clients/5C3JSOVVFiVmBoh8mv3I/reset-secret \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

Response:

```json
{
  "message": "Client secret reset successfully",
  "client": {
    "clientId": "5C3JSOVVFiVmBoh8mv3I",
    "clientSecret": "newly_generated_client_secret"
  }
}
```

> **Note**: After resetting the secret, the client must log in again with the new `clientSecret` to obtain a valid token, as the old token will no longer work.

## Next Steps After Creating a Client

After creating a client account, linking it to a GHL sub-account (if applicable), and setting up their access token, you should:

1. Securely provide the client with their `clientId` and `clientSecret` for API authentication
2. Instruct the client to log in using `POST /auth/login` to obtain their JWT token
3. Ensure the client can access their secure endpoints (e.g., `/secure/client`) with the token
4. If GHL integration is needed, follow the GHL integration steps and verify token status
5. Set up any additional configurations specific to the client's needs

## Common Issues and Troubleshooting

### Duplicate Email Error

If you receive a 409 Conflict error, the client email address may already exist in the system:

```json
{
  "error": "Client already exists with this ID or email",
  "details": "E11000 duplicate key error collection: clients index: clientMeta.email_1 dup key: { clientMeta.email: \"paul@affinitydesign.ca\" }"
}
```

**Resolution**: Use a different email address or update the existing client.

### Invalid Agent ID

If the agent ID doesn't exist in the ElevenLabs system, you may encounter errors when the client attempts to make calls.

**Resolution**: Verify the agent ID is valid by testing it with the ElevenLabs API before assigning it to a client.

### Invalid Twilio Phone Number

If the Twilio phone number is incorrectly formatted or not provisioned in your Twilio account:

```json
{
  "error": "Failed to create client",
  "details": "Invalid phone number format"
}
```

**Resolution**: Ensure the phone number is in E.164 format (+18632704910) and properly provisioned in your Twilio account.

### GHL Token Issues

If you encounter GHL token-related issues:

**Missing Tokens**:
```json
{
  "error": "No GHL integration",
  "details": "This client does not have GHL integration set up (no refresh token)"
}
```

**Resolution**: Complete the GHL authorization flow to obtain tokens.

**Expired Tokens**:
```json
{
  "status": "expired",
  "message": "Token is expired"
}
```

**Resolution**: Use the token refresh endpoint or re-authorize with GHL if the refresh token is also invalid.

**Token Refresh Failed**:
```json
{
  "success": false,
  "error": "GHL token refresh failed",
  "recommendation": "The client may need to re-authorize with GHL. Check if the GHL integration is still active."
}
```

**Resolution**: The refresh token may be invalid or expired. Complete the GHL authorization flow again.

### Login Failure Due to Inactive Status

If a client's status is "Inactive" or "Suspended", login will fail:

```json
{
  "error": "Invalid credentials or inactive client"
}
```

**Resolution**: Ensure the client's status is "Active" using the `/admin/clients/:clientId` endpoint to update it.

## Client Account Statuses

A client account can have one of the following statuses:

- **Active**: The client can authenticate and use all client-specific endpoints
- **Inactive**: The client cannot authenticate (typically used for clients no longer using the service)
- **Suspended**: The client cannot authenticate (typically used for temporary suspension due to billing or other issues)

## Best Practices

1. **Secure Storage of Credentials**:

   - Ensure the `clientSecret` is stored securely by the client and not exposed in logs or public repositories.
   - Use environment variables for sensitive data like `GHL_CLIENT_ID` and `GHL_CLIENT_SECRET`.

2. **GHL Integration**:

   - Always link the client to a GHL sub-account immediately after creation if GHL features are required.
   - Regularly check GHL token status to ensure tokens remain valid.
   - Use the token migration endpoint after system updates that affect token storage.
   - Monitor token expiration and implement automated alerts for tokens that fail to refresh.

3. **Client Communication**:

   - After creation, provide the client with clear instructions on how to log in and use their access token.
   - If GHL integration is required, ensure the sub-account owner is ready to authorize the app during setup.

4. **Regular Audits**:
   - Periodically review client accounts to ensure their statuses are accurate (e.g., mark inactive clients as "Inactive").
   - Check for outdated `calId` values if the GHL sub-account's calendar configuration changes.
   - Verify GHL token status regularly and refresh tokens as needed.

## Additional Resources

- **GHL Developer Documentation**: For more details on GHL OAuth and API usage, refer to the [GHL Developer Portal](https://developers.gohighlevel.com).
- **Twilio Documentation**: For Twilio phone number provisioning and usage, see the [Twilio Voice API Docs](https://www.twilio.com/docs/voice).
- **ElevenLabs Documentation**: For agent ID setup and usage, refer to the [ElevenLabs API Docs](https://elevenlabs.io/docs).
